<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Financial Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 h-screen flex flex-col">

    <!-- Header -->
    <div class="bg-blue-600 text-white p-4 text-center text-xl font-semibold shadow">
        Your Financial Assistant
    </div>

    <!-- Main Layout: Sidebar + Chat -->
    <div class="flex flex-1 overflow-hidden">

        <!-- Sidebar -->
        <aside class="w-64 bg-white border-r p-4 hidden md:block">
            <h2 class="text-lg font-semibold mb-4">Menu</h2>
            <button onclick="window.location.href='/financial_data'" class="w-full bg-blue-500 text-white py-2 px-3 rounded hover:bg-blue-600">
                ðŸ“Š Financial Info
            </button>
            <div class="p-4 border-b mb-4">
                <button onclick="location.href='/'" class="w-full bg-blue-500 text-white py-2 px-3 rounded-md hover:bg-blue-600" style="margin-left: -16px; width: 222px">
                  New Chat
                </button>
              </div>
            <div class="mt-6">
                <h3 class="text-md font-medium mb-2">Previous Chats</h3>
                <ul class="space-y-2 text-gray-700 text-sm">
                    <li class="truncate">ðŸ’¬ Mutual Fund Advice</li>
                    <li class="truncate">ðŸ’¬ Credit Score Query</li>
                    <li class="truncate">ðŸ’¬ Net Worth Check</li>
                </ul>
            </div>
        </aside>

        <!-- Chat Container -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <div class="flex justify-center flex-1 overflow-y-auto px-4 py-6">
                <div id="chat" class="w-full max-w-2xl space-y-4" style="scroll-behavior: smooth;">
                    <!-- Chat messages will be appended here -->
                </div>
            </div>

            <!-- Chat Input -->
            <div class="bg-white p-4 shadow-md sticky bottom-0">
                <div class="max-w-2xl mx-auto flex items-center space-x-2">
                    <textarea id="query" rows="2" placeholder="Ask something..." class="flex-1 resize-none p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    <button id="sendBtn" onclick="askGemini()" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 disabled:opacity-50" disabled>
                        Send
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const chat = document.getElementById("chat");
        const textarea = document.getElementById("query");
        const sendBtn = document.getElementById("sendBtn");

        // Enable Send button only when user types
        textarea.addEventListener("input", () => {
            sendBtn.disabled = textarea.value.trim() === "";
        });

        function appendMessage(text, isUser, isLoading = false) {
            const msg = document.createElement("div");
            msg.className = "max-w-xl px-4 py-2 rounded-lg whitespace-pre-wrap " +
                (isUser
                    ? "bg-blue-500 text-white self-end ml-auto"
                    : "bg-gray-200 text-gray-800 self-start mr-auto");
            msg.innerText = text;
            msg.setAttribute("data-loading", isLoading ? "true" : "false");

            const wrapper = document.createElement("div");
            wrapper.className = "flex " + (isUser ? "justify-end" : "justify-start");
            wrapper.appendChild(msg);
            chat.appendChild(wrapper);
            chat.scrollTop = chat.scrollHeight;
            return msg;
        }

    const chatHistory = [];
    let conversation = [];

    async function askGemini() {
  const query = textarea.value.trim();
  if (!query) return;

  sendBtn.disabled = true;

  // Append user's message to the chat UI
  appendMessage(query, true);
  textarea.value = "";

  // Store user message in conversation history
  conversation.push({ role: "user", text: query });

  // Display loading message
  const loadingMsg = appendMessage("Processing...", false, true);

  // Slice off the latest user message to keep in sync with backend formatting
  const history = conversation.slice(0, -1);

  // Debug: Log all key pieces
  console.log("Sending query:", query);
  console.log("History being sent:", JSON.stringify(history, null, 2));

  try {
    const res = await fetch('/ask_gemini', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ query, history })
    });

    const data = await res.json();
    console.log(" Response received:", data);

    if (data.response) {
      loadingMsg.innerText = data.response;

      // Store assistant response in history
      conversation.push({ role: "model", text: data.response });
    } else {
      loadingMsg.innerText = "Error: " + data.error;
      console.error("Error in response:", data.error);
    }
  } catch (err) {
    loadingMsg.innerText = "Network error. Please try again.";
    console.error("Network error:", err);
  } finally {
    sendBtn.disabled = false;
  }
}

    </script>
</body>
</html>
